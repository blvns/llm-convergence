import argparse
import json
import csv
import re
import spacy
import random
from tqdm import tqdm
from pathlib import Path

SUBSET_IDS = {
	'dailydialog': [1, 10, 100, 1000, 101, 102, 103, 105, 106, 107, 108, 109, 11, 110, 111, 112, 114, 115, 116, 119, 120, 121, 123, 124, 127, 129, 13, 130, 131, 132, 134, 136, 139, 14, 140, 141, 143, 144, 146, 147, 15, 150, 151, 154, 156, 157, 158, 159, 16, 161, 164, 165, 167, 168, 169, 17, 171, 172, 173, 174, 176, 177, 179, 18, 180, 181, 184, 185, 186, 187, 189, 19, 190, 192, 194, 195, 197, 198, 199, 2, 200, 201, 202, 204, 205, 206, 207, 208, 209, 21, 210, 212, 213, 214, 215, 216, 217, 218, 219, 22, 223, 224, 225, 228, 23, 230, 232, 233, 234, 237, 238, 239, 24, 240, 241, 242, 243, 245, 247, 25, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 26, 260, 262, 263, 266, 267, 268, 269, 27, 270, 273, 275, 276, 279, 28, 280, 281, 282, 283, 284, 286, 287, 29, 291, 292, 293, 294, 296, 297, 298, 30, 300, 301, 302, 303, 305, 306, 307, 308, 31, 310, 311, 312, 313, 315, 316, 317, 318, 319, 32, 320, 321, 323, 324, 325, 327, 328, 329, 33, 330, 331, 332, 333, 334, 337, 338, 34, 341, 343, 344, 346, 347, 35, 352, 355, 358, 36, 360, 362, 363, 364, 365, 367, 368, 369, 372, 373, 376, 377, 38, 380, 382, 383, 384, 386, 387, 388, 389, 390, 391, 393, 394, 395, 396, 397, 4, 40, 400, 402, 404, 405, 406, 407, 408, 41, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 427, 428, 429, 43, 430, 432, 433, 434, 435, 436, 437, 438, 439, 44, 440, 442, 443, 446, 447, 449, 45, 453, 454, 457, 458, 460, 465, 466, 467, 468, 469, 47, 470, 474, 475, 476, 477, 478, 48, 480, 481, 482, 483, 484, 485, 49, 490, 491, 492, 493, 494, 495, 496, 497, 498, 5, 50, 500, 501, 502, 504, 505, 507, 509, 51, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, 522, 523, 524, 525, 527, 528, 529, 530, 531, 532, 533, 535, 539, 540, 541, 542, 543, 544, 548, 549, 55, 550, 551, 552, 553, 554, 556, 557, 559, 56, 560, 561, 562, 564, 565, 568, 569, 57, 570, 572, 573, 574, 576, 579, 58, 581, 582, 583, 584, 585, 587, 588, 59, 591, 592, 593, 594, 598, 599, 601, 603, 606, 607, 608, 61, 611, 613, 614, 618, 619, 62, 622, 624, 625, 626, 628, 63, 631, 632, 633, 635, 637, 638, 639, 642, 644, 645, 646, 647, 648, 649, 65, 650, 651, 652, 654, 655, 656, 657, 658, 659, 66, 660, 661, 662, 663, 664, 665, 667, 669, 67, 671, 672, 674, 676, 677, 678, 680, 681, 687, 688, 690, 691, 695, 696, 699, 7, 70, 700, 703, 704, 705, 706, 707, 708, 709, 71, 710, 711, 713, 715, 716, 718, 72, 720, 721, 725, 727, 728, 730, 732, 733, 734, 735, 737, 738, 739, 740, 741, 742, 743, 744, 745, 746, 747, 749, 75, 751, 754, 755, 758, 76, 760, 762, 763, 764, 765, 766, 767, 768, 769, 77, 771, 772, 773, 774, 775, 776, 778, 779, 78, 781, 782, 783, 784, 785, 786, 788, 79, 791, 792, 793, 795, 796, 799, 8, 802, 803, 805, 806, 807, 809, 810, 811, 812, 813, 814, 815, 816, 817, 818, 819, 82, 821, 822, 824, 825, 827, 829, 83, 830, 831, 832, 833, 834, 835, 836, 837, 839, 840, 842, 844, 845, 846, 847, 848, 849, 85, 850, 851, 852, 853, 854, 855, 856, 857, 858, 859, 86, 860, 862, 863, 864, 865, 866, 867, 868, 869, 87, 873, 875, 876, 879, 88, 880, 881, 882, 883, 884, 886, 887, 888, 889, 89, 890, 891, 896, 897, 898, 9, 90, 901, 902, 903, 904, 905, 907, 908, 91, 910, 911, 912, 913, 914, 915, 917, 919, 920, 921, 923, 925, 926, 927, 928, 929, 93, 930, 931, 932, 934, 935, 936, 939, 940, 941, 942, 943, 944, 945, 946, 948, 949, 95, 950, 951, 952, 954, 955, 956, 957, 958, 96, 960, 963, 964, 966, 967, 968, 969, 97, 970, 971, 972, 973, 976, 977, 978, 979, 981, 983, 984, 985, 986, 99, 990, 991, 992, 993, 995, 996, 997, 999],
	'movie':[1, 10004, 10010, 10012, 10020, 10040, 10052, 10062, 10137, 10138, 1019, 10215, 10223, 10231, 10258, 10261, 10262, 10265, 10266, 10269, 10306, 10313, 10315, 1033, 10335, 10343, 10347, 10348, 1037, 10373, 10380, 10388, 10409, 10416, 10426, 10431, 10449, 10452, 10453, 10481, 1049, 10490, 10502, 10515, 10550, 10559, 10566, 10573, 1059, 10590, 10592, 10603, 10613, 10639, 1067, 10696, 10698, 10722, 10724, 10733, 10738, 10743, 10744, 10747, 10752, 10762, 10766, 10768, 10774, 10778, 10789, 10791, 10804, 10815, 10822, 10824, 10838, 10841, 10855, 10856, 10868, 10879, 10886, 1091, 10920, 10921, 10927, 10934, 10935, 10937, 10948, 10952, 10961, 1098, 10981, 10984, 10985, 10994, 10997, 11010, 11034, 11037, 11038, 1104, 11049, 11076, 11141, 11184, 1120, 11216, 11227, 11326, 11366, 11400, 11422, 11476, 1148, 11480, 11520, 11543, 11572, 11578, 11602, 11604, 1161, 1163, 11630, 11637, 11665, 11682, 11708, 11773, 11777, 11785, 11786, 11814, 11832, 11835, 11847, 119, 11908, 11927, 11936, 11937, 12003, 12020, 12032, 12037, 12052, 12053, 12084, 1211, 12167, 12168, 12177, 12181, 12187, 122, 12219, 12226, 12235, 12247, 1230, 12408, 1241, 12489, 12494, 12517, 12554, 12570, 12591, 12641, 12655, 12656, 12675, 12678, 12693, 12704, 12705, 12707, 12726, 12734, 12758, 12787, 1280, 12810, 12817, 12824, 12840, 12853, 12864, 12875, 12897, 12924, 12925, 12938, 12939, 12954, 12961, 12990, 12991, 12993, 12995, 13009, 13055, 13058, 13072, 13080, 13093, 1313, 13141, 13166, 13200, 13231, 1330, 13316, 13353, 1349, 13525, 13681, 13697, 13699, 13781, 13808, 13814, 13817, 13818, 13821, 13827, 13859, 13876, 13880, 13884, 13887, 13901, 13902, 13907, 13910, 13911, 13914, 13920, 13926, 13939, 13949, 13968, 13978, 13983, 14044, 1409, 14091, 14095, 1410, 14147, 14161, 14180, 14211, 14278, 14286, 14313, 14316, 1436, 1437, 1439, 144, 14408, 14416, 14427, 1443, 14436, 1444, 1446, 14467, 14475, 14484, 145, 1450, 14513, 14525, 14527, 14535, 14539, 14540, 14568, 1464, 14652, 1470, 14740, 14742, 14812, 14903, 14905, 14932, 14933, 14934, 14948, 1498, 14984, 14990, 14997, 15012, 15016, 15071, 15108, 15121, 15125, 15139, 15151, 15153, 15163, 15172, 15177, 15181, 15182, 15183, 15190, 15194, 15197, 1520, 1522, 15225, 15249, 15252, 15256, 15274, 15279, 15283, 15306, 15330, 15352, 15359, 15360, 15375, 15442, 15458, 15465, 15466, 15468, 15478, 15480, 15486, 15491, 15493, 1550, 15518, 15526, 15537, 1556, 15560, 15564, 15623, 15643, 15650, 15654, 15672, 15694, 15707, 1572, 15722, 15741, 15775, 15796, 15824, 15836, 15864, 15878, 15879, 15982, 16039, 1609, 16137, 1615, 16199, 1621, 1623, 16248, 16302, 16313, 16331, 16335, 16343, 16351, 16356, 16362, 16391, 16394, 164, 16422, 16445, 16451, 16459, 16557, 16573, 16607, 16612, 16623, 16634, 16638, 16655, 16656, 16659, 16661, 16669, 16673, 16674, 1668, 16682, 16710, 16719, 16739, 16833, 16857, 16861, 16868, 16887, 16966, 16983, 16987, 17010, 17015, 17018, 17030, 17096, 17112, 17115, 17131, 17145, 17163, 17164, 17168, 17182, 17210, 17211, 17245, 17252, 17269, 17274, 17295, 17335, 17338, 17359, 17364, 17379, 17392, 1742, 17455, 17468, 17476, 17477, 17482, 17490, 17494, 17511, 17563, 1762, 1763, 1770, 17725, 17766, 17792, 17796, 1781, 17878, 17885, 17894, 17906, 17910, 17913, 17917, 17922, 17925, 17930, 17933, 17943, 17946, 17958, 17968, 1797, 17973, 17974, 17989, 17991, 17994, 17996, 18, 18004, 18010, 18021, 18031, 18107, 1817, 18177, 18178, 18264, 18276, 18296, 1831, 18312, 18317, 18378, 18384, 18387, 18406, 18415, 18422, 18427, 18435, 18456, 18472, 18524, 18541, 18548, 1855, 18553, 18569, 18591, 18615, 18616, 18618, 18620, 18627, 18651, 18692, 18693, 18767, 18815, 18822, 18826, 18828, 18837, 18840, 18842, 18846, 18849, 18851, 18854, 18855, 18856, 18873, 18897, 1892, 18920, 18942, 18965, 18977, 18994, 18995, 18996, 18998, 190, 19001, 19005, 19008, 19009, 19026, 19073, 19085, 19087, 19089, 19091, 19094, 19117, 19122, 19125, 19150, 19153, 19162, 19181, 19189, 19228, 19234, 19242, 19270, 19271, 19279, 19284, 19294, 19317, 19318, 19321, 19343, 19346, 19375, 19385, 19390, 19403, 19408, 19429, 19432, 19439, 19453, 19455, 19510, 19536, 19547, 1958, 19604, 19621, 19651, 19662, 19683, 19720, 19721, 19733, 19738, 19739, 19766, 19789, 19815, 19817, 19834, 19838, 19854, 19863, 19871, 19877, 1989, 19908, 19912, 19913, 19914, 19928, 19935, 19969, 19990, 19992, 19994, 19998, 20008, 20018, 20033, 20035, 20045, 20049, 20051, 20053, 20055, 20058, 20063, 20068, 20070, 20072, 20090, 20099, 20102, 20127, 20143, 20155, 20171, 20190, 20213, 20225, 20226, 20236, 2024, 20254, 20256, 20260, 20261, 20295, 20305, 20311, 20313, 20314, 20315, 20346, 20348, 20349, 20371, 20443, 20454, 20469, 20478, 20483, 20498, 20505, 20506, 20515, 20523, 20530, 20543, 20561, 2057, 20572, 20588, 20592, 20609, 20612, 20625, 20630, 20652, 20660, 20700, 20701, 20736, 2074, 20748, 20750, 20759, 20787, 20816, 20846, 20863, 20872, 20875, 20879, 20880, 20892, 20893, 20902, 20928, 20949, 2098, 20988, 2101, 21028, 21045, 21083, 21087, 21112, 21118, 21119, 21133, 21183, 21187, 21192, 21210, 21214, 2122, 21234, 21238, 21251, 21253, 21260, 21262, 21267, 21272, 21296, 21301, 2133, 2135, 21364, 21410, 21437, 21496, 21500, 21510, 21514, 21558, 21608, 21619, 2163, 21631, 21636, 21638, 2164, 21645, 2165, 21654, 21658, 21662, 21687, 21693, 21714, 21721, 21737, 21746, 21792, 21801, 21811, 21813, 21826, 21832, 21833, 21835, 21839, 21844, 21846, 21847, 21862, 21878, 21892, 21902, 21906, 21908, 21925, 21937, 21962, 21984, 22001, 22015, 22017, 22027, 22048, 22054, 22062, 22063, 22065, 22067, 22068, 22074, 22077, 22090, 2211, 22132, 22148, 22152, 22156, 22175, 22178, 22183, 22196, 22210, 22212, 22217, 22244, 22253, 22256, 22261, 22301, 22304, 22322, 2233, 22337, 22338, 22344, 22354, 22359, 22360, 22369, 2237, 22399, 22402, 22404, 22412, 22419, 2242, 22425, 22431, 22446, 22453, 22454, 2246, 22467, 22473, 22480, 22482, 22486, 22534, 22545, 22635, 22700, 22710, 2277, 22802, 22844, 22855, 22875, 2288, 22880, 2290, 22917, 2295, 22958, 22965, 22969, 22975, 22988, 22996, 2305, 23068, 23101, 23128, 23132, 23133, 23166, 23200, 23211, 23269, 2327, 23279, 23282, 23289, 23290, 23292, 23320, 23322, 23337, 23353, 23356, 23371, 23376, 23380, 2340, 23417, 2343, 23431, 23435, 23444, 23462, 23499, 23500, 23503, 23504, 23512, 23516, 23534, 23535, 23539, 23553, 23558, 23560, 23576, 23597, 23601, 23608, 23632, 23678, 23683, 23693, 237, 23715, 2374, 23751, 23781, 23784, 23817, 23827, 23834, 23841, 23872, 23879, 23893, 23929, 23947, 23951, 23959, 23968, 23969, 24007, 24018, 24030, 24044, 24061, 24064, 24104, 2411, 24110, 24118, 24163, 24177, 24184, 24279, 2428, 24280, 24283, 2429, 24315, 24324, 24360, 24385, 24411, 24421, 24445, 24446, 24452, 24483, 245, 24535, 24541, 24545, 24554, 2456, 24563, 24602, 24690, 24705, 24748, 24749, 2475, 24760, 24763, 24770, 24771, 24787, 24795, 24819, 24825, 24830, 24840, 24860, 2487, 24878, 2489, 24894, 24908, 24969, 24971, 24976, 24978, 24981], 
	'npr': [0, 1, 100, 1000, 10000, 10001, 10008, 10009, 1001, 10011, 10012, 10021, 10022, 10025, 10029, 10032, 10035, 10039, 10040, 10041, 10043, 10044, 10045, 10047, 10050, 10053, 10056, 10060, 10063, 10069, 1007, 10072, 10077, 10079, 10080, 10085, 10086, 10089, 1009, 10091, 10094, 10096, 10106, 10107, 1011, 10112, 10113, 10116, 10117, 10121, 10123, 10128, 1013, 10130, 10132, 10133, 10135, 10136, 10138, 10140, 10142, 10146, 10147, 10148, 10152, 10153, 10154, 10155, 10157, 10158, 1016, 10162, 10163, 10166, 1017, 10178, 10179, 10180, 10182, 10185, 10188, 1019, 10193, 10194, 10195, 10198, 10200, 10202, 10204, 10206, 10207, 10209, 10212, 10215, 10230, 10233, 10236, 10239, 10240, 10241, 10246, 10247, 10250, 10252, 10254, 10257, 10258, 10259, 10261, 10262, 10264, 10268, 10270, 10271, 10273, 10276, 10278, 10280, 10281, 10282, 10284, 10285, 10287, 10290, 10298, 10300, 10302, 10304, 10306, 10307, 10308, 10310, 10312, 10316, 10317, 10320, 10323, 10325, 10335, 10339, 10341, 10342, 10346, 10350, 10357, 10360, 10362, 10366, 10368, 1037, 10371, 10374, 1038, 10380, 10382, 10384, 10387, 10391, 10393, 10395, 10398, 10405, 10407, 1041, 10422, 10424, 10425, 1043, 10430, 10432, 10434, 10437, 10439, 10440, 10444, 10445, 10449, 10450, 10452, 10455, 10456, 10464, 1047, 10474, 10477, 10482, 10485, 10486, 10490, 10492, 10495, 10496, 10498, 10499, 1050, 10501, 10506, 1052, 10521, 10524, 10526, 10528, 10529, 10536, 10541, 10546, 10547, 10548, 10549, 10550, 10552, 10557, 10562, 10563, 10565, 10570, 10574, 10577, 10578, 1058, 10580, 10583, 10587, 10589, 10590, 10594, 10599, 10601, 10604, 10606, 10607, 10609, 10613, 10614, 10616, 10617, 10619, 1062, 10620, 10621, 10623, 10624, 10627, 1063, 10631, 10632, 10633, 10635, 10636, 10638, 10641, 10642, 10648, 10651, 10652, 10655, 10657, 10659, 1066, 10660, 10665, 10666, 10667, 10671, 10675, 10678, 10679, 1068, 10681, 10683, 10688, 1069, 10693, 10694, 10695, 1070, 10700, 10701, 10702, 10703, 10707, 1071, 10710, 10711, 10714, 10715, 10721, 10722, 10725, 10733, 10736, 10738, 1074, 10740, 10746, 10748, 10749, 1075, 10754, 10756, 10757, 10758, 10761, 10763, 10775, 10778, 10785, 10787, 10789, 10795, 10796, 10797, 10798, 10808, 10811, 10813, 10818, 1082, 10821, 10824, 10825, 10829, 10831, 10835, 10838, 10839, 10841, 10843, 10844, 10845, 10846, 10847, 10848, 10852, 10855, 10856, 10857, 10858, 10859, 10861, 10864, 10867, 10868, 1087, 10875, 10876, 10882, 10883, 10885, 10887, 10895, 10898, 10899, 10907, 10911, 10915, 1092, 10920, 10921, 10922, 10927, 10931, 10936, 10937, 10939, 10940, 10941, 10945, 10947, 10948, 10949, 10950, 10953, 10957, 10963, 10964, 10965, 10966, 1097, 10971, 10972, 10975, 10976, 10978, 1098, 10980, 10981, 10983, 10984, 10985, 10989, 10993, 10998, 110, 1100, 11005, 11006, 11008, 11009, 11010, 11011, 11018, 11021, 11025, 11026, 1103, 11030, 11031, 11033, 11034, 11036, 11037, 11039, 11040, 11041, 11042, 11046, 11048, 11051, 11056, 11060, 11061, 11062, 11063, 11068, 11072, 11073, 11080, 11081, 11083, 11087, 1109, 11090, 11092, 11094, 11096, 111, 11100, 11103, 11104, 11105, 11107, 11114, 11118, 11121, 11122, 11125, 11126, 11129, 11130, 11132, 11133, 11137, 11141, 11145, 11147, 11148, 11150, 11157, 11159, 11160, 11163, 11165, 11167, 1117, 11172, 11173, 11178, 11180, 11185, 11187, 1119, 11190, 11192, 11193, 11194, 11202, 11203, 11209, 11210, 11212, 11215, 11218, 1122, 11220, 11229, 11232, 11239, 11241, 11247, 11248, 1125, 11251, 11259, 1126, 11268, 11271, 11272, 11273, 11281, 11285, 11286, 11287, 1129, 11290, 11292, 11293, 11295, 11296, 11297, 11298, 1130, 11300, 11304, 11308, 11311, 11312, 11313, 11314, 11315, 11317, 11322, 11325, 11326, 11329, 1133, 11330, 11333, 11334, 11337, 11340, 11343, 11344, 11345, 11348, 11351, 11353, 11367, 1137, 11370, 11374, 11379, 11380, 11381, 11383, 11386, 11387, 11390, 11391, 11393, 11395, 11398, 11399, 11403, 11407, 11409, 1141, 11412, 11414, 11426, 11427, 11432, 11435, 1144, 11448, 11449, 11453, 11455, 11456, 11457, 11459, 11460, 11463, 11466, 11469, 11470, 11477, 11478, 1148, 11485, 1149, 1150, 11503, 11504, 11505, 11506, 11509, 1151, 11521, 11523, 11524, 11526, 11528, 1153, 11533, 11537, 11539, 11544, 11548, 11549, 11551, 11553, 11554, 11558, 11567, 1158, 11581, 11584, 11586, 11589, 11590, 11591, 11592, 11595, 11599, 116, 1160, 11602, 11603, 1161, 11615, 11616, 11620, 11623, 11625, 11626, 11630, 11632, 11633, 11635, 1164, 11640, 11642, 11646, 11652, 11654, 11655, 11656, 11661, 11662, 11663, 11665, 11667, 11669, 11670, 11671, 11672, 11673, 11675, 11677, 11678, 11680, 11682, 11683, 11684, 11686, 11688, 1169, 11690, 11692, 11696, 117, 1170, 11702, 11703, 11715, 11717, 11721, 11722, 11726, 11727, 1173, 11732, 11739, 1174, 11740, 11744, 11745, 11746, 11747, 11748, 11752, 11753, 11761, 11766, 1177, 11774, 11776, 11778, 11779, 1178, 11786, 11787, 11791, 11793, 11796, 11797, 11804, 11808, 1181, 11814, 11815, 11818, 11820, 11821, 11822, 11825, 11827, 11832, 11835, 11837, 1184, 11840, 11841, 11842, 11845, 11846, 1185, 11854, 11862, 11863, 11866, 11869, 11870, 11874, 11875, 11876, 11883, 1189, 11895, 11897, 119, 1190, 11901, 11902, 11904, 11905, 11907, 11918, 1192, 11920, 11923, 11926, 11927, 11933, 11934, 11939, 1194, 11941, 11942, 11943, 11944, 11945, 11950, 11954, 11955, 11957, 11962, 11963, 11969, 11971, 11974, 11975, 11980, 11981, 11983, 11985, 11988, 11989, 1199, 11992, 11994, 12000, 12001, 12002, 12005, 12007, 12011, 12012, 12013, 12015, 12017, 12021, 12023, 12028, 12030, 12033, 12034, 12035, 12038, 12039, 12041, 12043, 12044, 12047, 12048, 12054, 12056, 12058, 12062, 12063, 12066, 12070, 12075, 1208, 12080, 12086, 12087, 1209, 12090, 12095, 12097, 12099, 1210, 12102, 12114, 12117, 1212, 12120, 12122, 12128, 12129, 12133, 12138, 12139, 12143, 12144, 12147, 12149, 12150, 12155, 12164, 1217, 12170, 12171, 12177, 12178, 12179, 12184, 12185, 12186, 12188, 12189, 12194, 12196, 122, 12201, 12205, 12207, 1221, 12210, 12212, 12215, 1222, 12220, 12225, 12227, 12240, 12243, 12244, 12245, 12249, 1225, 12252, 12258, 12259, 1226, 12269, 12274, 12278, 12279, 12280, 12281, 12284, 12286, 12287, 12290, 12294, 12295, 12297, 12300, 12301, 12303, 12309, 12312, 12313, 12314, 12318, 12320, 12322, 12323, 12326, 12328, 12331, 12336, 12338, 12339, 1234, 12347, 12350, 12351, 12352, 12357, 12361, 12362, 12364, 12365, 12366, 12369, 12370, 12375, 12376, 12378, 12382, 12383, 12384, 12390, 12392, 12397, 12399, 1240, 12405, 12407, 12413, 12419, 1242, 12420, 12421, 12422, 12429, 12436, 12437, 12440, 12441, 12445, 12446, 12447, 1245, 12450, 12451, 12453, 12457, 12458, 1246, 12462, 12467, 12469, 12471, 12473, 12474, 12479, 1248, 12487, 12490, 12493, 12494, 12496, 1251, 12515, 12517, 1252, 12521, 12530, 12539, 1254, 12541, 12545, 12547, 12549, 12550, 12555, 12556, 1256, 12568, 12570, 12573, 12575, 12578, 1258, 12580, 12581, 12584, 1259, 12590, 12593, 12594, 12595, 12597, 126, 12600, 12603, 12605, 12608, 1261, 12617, 12618, 12619, 1262, 12624, 12630],
}

def _load_liwc(fp):
	lexicon = {}
	with open(fp, "r", newline="") as csvfile:
		reader = csv.reader(csvfile)
		liwc_data = list(reader)  # Read all rows into a list
	for row in liwc_data:
		cat = row[0] #subcat = row[1], which we don't use
		if cat not in lexicon: lexicon[cat] = []
		choices = [c for c in row[2:] if len(c) > 0]
		lexicon[cat].extend(choices)
	return lexicon
LIWC_LEXICON = _load_liwc("./data/liwc/liwc2007_subset.csv")

def random_reference(data, convo_id, corpus):
	#sample random conversation id other than the current one
	convo_rand = random.sample(SUBSET_IDS[corpus], 2)
	convo_rand = convo_rand[0] if convo_rand[0] != int(convo_id) else convo_rand[1]

	#sample random utterance
	convo_rand = data[str(convo_rand)]
	utter_rand = random.sample(convo_rand, 1)[0]

	return utter_rand

def _pos_comparison(trg_pos, ref_pos):
	tagset = ['ADJ', 'ADV', 'INTJ', 'NOUN', 'PROPN', 'VERB', 'ADP', 'AUX', 'CCONJ', 'DET', 'NUM', 'PART', 'PRON', 'SCONJ', 'PUNCT'] #dropped sym, x
	pos_stats = []

	#get trg, ref dist over POS tags + construct fine-grained stats 
	for tag in tagset:
		t_score = len([p for p in trg_pos if p == tag])/len(trg_pos)
		r_score = len([p for p in ref_pos if p == tag])/len(ref_pos)
		k = 'pos_{}'.format(tag.lower())
		pos_stats.append((k, _lsm(t_score, r_score)))

	return pos_stats

def _liwc_comparison(trg_tokens, ref_tokens):
	liwc_stats = []

	def _liwc_match(token, lexicon):
		token = token.lower()
		for l in lexicon:
			#if l.endswith("*") and re.match(l[:-1], token): return True
			#elif l == token: return True
			if re.fullmatch(l, token): return True
		return False

	#get trg, ref dist over POS tags + construct fine-grained stats 
	for liwc_cat in LIWC_LEXICON:
		lexicon = LIWC_LEXICON[liwc_cat]
		t_matches = [tok for tok in trg_tokens if _liwc_match(tok, lexicon)]
		r_matches = [tok for tok in ref_tokens if _liwc_match(tok, lexicon)]
		t_score = len(t_matches)/len(trg_tokens)
		r_score = len(r_matches)/len(ref_tokens)
		if liwc_cat == "conj": 
			print(len(t_matches))

		k = 'liwc_{}'.format(liwc_cat.lower())
		liwc_stats.append((k, _lsm(t_score, r_score)))

	return liwc_stats

def _lsm(a, b):
	eps = 0.00001
	l = 1-(abs(a-b))/(a+b+eps)
	return l

def analyze(trg_text, ref_text, parser):

	#parse texts with spacy
	trg_doc = parser(trg_text, disable=["entity", "parser"])
	trg_tokens = [token.text for token in trg_doc]
	trg_pos = [token.pos_ for token in trg_doc]

	#handle empty outputs from model
	if len(trg_tokens) == 0:
		trg_tokens = [""]
		trg_pos = [""]

	ref_doc = parser(ref_text, disable=["entity", "parser"])
	ref_tokens = [token.text for token in ref_doc]
	ref_pos = [token.pos_ for token in ref_doc]

	stats = {}
	#calculate statistics -- utterance length
	k = 'utter_diff'
	v = _lsm(len(trg_tokens), len(ref_tokens))
	stats[k] = v

	#calculate statistics -- pos_dist 
	result_arr = _pos_comparison(trg_pos, ref_pos)
	for k, v in result_arr: stats[k] = v

	#calculate_stats -- LIWC features
	result_arr = _liwc_comparison(trg_tokens, ref_tokens)
	for k, v in result_arr: stats[k] = v


	#calculate statistics -- PROPN
	trg_propn = [t.lower() for t, p in zip(trg_tokens, trg_pos) if p == "PROPN"]
	ref_propn = [t.lower() for t, p in zip(ref_tokens, ref_pos) if p == "PROPN"]
	shared_propn = list(set(trg_propn) & set(ref_propn))
	num_shared = len(shared_propn)
	k = 'propn'
	stats[k] = num_shared

	#calculate statistics -- hedge words
	#not implemented yet?

	#calculate statistics -- token novelty
	novel_tokens = [t for t in trg_tokens if t not in ref_tokens]
	novel_count = len(list(set(novel_tokens)))
	norm_count = novel_count/len(trg_tokens)
	k = 'novel_tok'
	stats[k] = norm_count

	return stats

def agg_dataset(statistics):
	dataset_stats = {}

	for utter_key in statistics.keys():
		for feat, value in statistics[utter_key].items():
			if feat not in dataset_stats: dataset_stats[feat] = []
			dataset_stats[feat].append(value)

	for feat, value_arr in dataset_stats.items():
		dataset_stats[feat] = sum(value_arr)/len(value_arr)

	#construct aggregated pos features -- summed dist overlap
	p_arr = [v for k,v in dataset_stats.items() if 'pos_' in k]
	p_mean = sum(p_arr)/len(p_arr)
	dataset_stats['pos_mean'] = p_mean

	#construct aggregated LIWC features
	l_arr = [v for k,v in dataset_stats.items() if 'liwc_' in k]
	l_mean = sum(l_arr)/len(l_arr)
	dataset_stats['liwc_mean'] = l_mean

	statistics['ALL'] = dataset_stats
	return statistics

#TODO implement
def _stepwise(args, data, parser):
	stats = {}
	for i in range(0,5): stats[i] = {}
	for convo_id in tqdm(list(data.keys())):
		#filter out unprocessed examples for human/random baseline
		if int(convo_id) not in SUBSET_IDS[args.corpus]: continue
		convo = data[convo_id]

		#examine the first model-generated turn...
		utter = convo[5]

		#against each of the four turns before it
		for utter_id in range(0, 5):
			utter_c = convo[utter_id]
			#assert utter["role"] == "model"
			s = analyze(utter['content'], utter_c['content'], parser)

			utter_key = "{}:{}".format(convo_id, utter_id)
			stats[utter_id][utter_key] = s

	#calculate overall result across dataset as final row
	for i in range(0,5):
		s = agg_dataset(stats[i])
		stats[i] = s['ALL']

	#write out analysis results
	out_path = './stylometrics/analysis/{}/{}/stepwise_stats.json'.format(args.corpus, args.setting_name)
	Path("./stylometrics/analysis/{}/{}".format(args.corpus, args.setting_name)).mkdir(parents=True, exist_ok=True)

	with open(out_path, "w", encoding="utf-8") as f:
            json.dump(stats, f, indent=4, ensure_ascii=False)

def main(args):
	#read in conversation file
	with open(args.data_path, 'r', encoding="utf-8") as f:
		data = json.load(f)

	#load spacy parser
	parser = spacy.load("en_core_web_trf")

	if args.setting == "stepwise":
		_stepwise(args, data, parser)
		return

	stats = {}
	for convo_id in list(data.keys()): #tqdm(list(data.keys())):
		#filter out unprocessed examples for human/random baseline
		if int(convo_id) not in SUBSET_IDS[args.corpus]: continue
		convo = data[convo_id]

		for utter_id in range(5, len(convo), 2):
			utter = convo[utter_id]
			if args.setting == 'random': utter_c = random_reference(data, convo_id, args.corpus)
			else: utter_c = convo[utter_id-1]

			if args.setting == "model": assert utter["role"] == "model"
			else: assert utter["role"] == "assistant"
			s = analyze(utter['content'], utter_c['content'], parser)

			utter_key = "{}:{}".format(convo_id, utter_id)
			stats[utter_key] = s

	#calculate overall result across dataset as final row
	stats = agg_dataset(stats)

	#write out analysis results
	out_path = './stylometrics/analysis/{}/{}/stats.json'.format(args.corpus, args.setting_name)
	Path("./stylometrics/analysis/{}/{}".format(args.corpus, args.setting_name)).mkdir(parents=True, exist_ok=True)

	with open(out_path, "w", encoding="utf-8") as f:
            json.dump(stats, f, indent=4, ensure_ascii=False)

if __name__ == "__main__":
	parser = argparse.ArgumentParser(description="Post-process stylometrics features.")
	parser.add_argument("--data_path", 
						type=str, 
						required=True,
						help="Path to all of the dir with model ouputs or baseline conversations.")
	parser.add_argument("--setting", 
						type=str, 
						required=True,
						choices=['random', 'human', 'model', 'stepwise'] )
	parser.add_argument("--corpus", 
						type=str, 
						required=True,
						choices=['movie', 'dailydialog', 'npr'])
	parser.add_argument("--setting_name", 
						type=str, 
						required=True)
	args = parser.parse_args()
	main(args)